"use strict";(self.webpackChunkgha_trigger=self.webpackChunkgha_trigger||[]).push([[837],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(n),d=i,h=c["".concat(l,".").concat(d)]||c[d]||m[d]||r;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:i,o[1]=s;for(var u=2;u<r;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8503:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>u});var a=n(7462),i=(n(7294),n(3905));const r={sidebar_position:300},o="GitHub Actions (CI Repository)",s={unversionedId:"github-actions",id:"github-actions",title:"GitHub Actions (CI Repository)",description:"In CI Repository, workflow files and scripts used in CI are managed.",source:"@site/docs/github-actions.md",sourceDirName:".",slug:"/github-actions",permalink:"/github-actions",draft:!1,editUrl:"https://github.com/gha-trigger/gha-trigger.github.io/edit/main/docs/github-actions.md",tags:[],version:"current",sidebarPosition:300,frontMatter:{sidebar_position:300},sidebar:"tutorialSidebar",previous:{title:"GitHub Apps",permalink:"/config/github-app"},next:{title:"Supported Events",permalink:"/events"}},l={},u=[{value:"Example",id:"example",level:2},{value:"Workflow Dispatch&#39;s inputs",id:"workflow-dispatchs-inputs",level:2},{value:"Actions for gha-trigger",id:"actions-for-gha-trigger",level:2},{value:"How to use Actions",id:"how-to-use-actions",level:3},{value:"Use GitHub App instead of <code>${{ github.token }}</code>",id:"use-github-app-instead-of--githubtoken-",level:2},{value:"Useful environment variables",id:"useful-environment-variables",level:2},{value:"Override default environment variables in <code>run</code>",id:"override-default-environment-variables-in-run",level:3},{value:"Update commit statuses per workflow",id:"update-commit-statuses-per-workflow",level:2},{value:"\ud83d\udca1 (Optional) Create branches for OIDC",id:"-optional-create-branches-for-oidc",level:2}],p={toc:u};function c(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"github-actions-ci-repository"},"GitHub Actions (CI Repository)"),(0,i.kt)("p",null,"In CI Repository, workflow files and scripts used in CI are managed.\n",(0,i.kt)("inlineCode",{parentName:"p"},"gha-trigger")," triggers CI Repository's workflows by ",(0,i.kt)("inlineCode",{parentName:"p"},"workflow_dispatch")," API."),(0,i.kt)("h2",{id:"example"},"Example"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/example-ci"},"Repository")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/example-ci/blob/main/.github/workflows/test_pull_request.yaml"},"Workflow"))),(0,i.kt)("h2",{id:"workflow-dispatchs-inputs"},"Workflow Dispatch's inputs"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"on:\n  workflow_dispatch:\n    inputs:\n      data:\n        required: true\n")),(0,i.kt)("p",null,"The input ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," is a JSON string.\nTo get data from ",(0,i.kt)("inlineCode",{parentName:"p"},"data"),", you have to parse ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," with ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/learn-github-actions/expressions#fromjson"},"fromJSON"),"."),(0,i.kt)("p",null,"e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"env:\n  PR_NUMBER: ${{fromJSON(inputs.data).event.pull_request.number}}\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"data")," has the following fields."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"event: ",(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows"},"Webhook event payload")),(0,i.kt)("li",{parentName:"ul"},"event_name: event name (e.g. ",(0,i.kt)("inlineCode",{parentName:"li"},"push"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"pull_request"),")"),(0,i.kt)("li",{parentName:"ul"},"changed_files: changed files by push or pull_request event",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/rest/pulls/pulls#list-pull-requests-files"},"pull_request")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/rest/commits/commits#get-a-commit"},"push")),(0,i.kt)("li",{parentName:"ul"},"Note that files are included up to 3000 files due to the GitHub API restriction"))),(0,i.kt)("li",{parentName:"ul"},"pull_request: ",(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/rest/pulls/pulls#get-a-pull-request"},"pull request"))),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"changed_files")," is got only when ",(0,i.kt)("inlineCode",{parentName:"p"},"paths")," filters are used."),(0,i.kt)("p",null,"e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"- matches:\n    - events:\n        - name: pull_request\n      paths:\n        - type: equal\n          value: README.md\n")),(0,i.kt)("p",null,"In case of ",(0,i.kt)("inlineCode",{parentName:"p"},"pull_request")," event, gha-trigger gets a pull request data until ",(0,i.kt)("inlineCode",{parentName:"p"},"mergeable")," becomes not ",(0,i.kt)("inlineCode",{parentName:"p"},"null")," and set the result to ",(0,i.kt)("inlineCode",{parentName:"p"},"data"),"'s ",(0,i.kt)("inlineCode",{parentName:"p"},"pull_request")," field."),(0,i.kt)("h2",{id:"actions-for-gha-trigger"},"Actions for gha-trigger"),(0,i.kt)("p",null,"gha-trigger provides some GitHub Actions."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/start-action"},"start-action"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/set-env-action"},"set-env-action")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/commit-status-action"},"commit-status-action")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/end-action"},"end-action"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/commit-status-action"},"commit-status-action")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/gha-trigger/step-summary-action"},"step-summary-action"))),(0,i.kt)("p",null,"gha-trigger's Workflow is different from normal GitHub Actions Workflow, so you have to do some additional tasks.\nFor example, you have to update commit statuses yourself."),(0,i.kt)("p",null,"These actions do the common tasks and let you concentrate on the main workflow implementation."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Show how to rerun and cancel workflow in GITHUB_STEP_SUMMARY"),(0,i.kt)("li",{parentName:"ul"},"Set useful Environment Variables"),(0,i.kt)("li",{parentName:"ul"},"Generate GitHub App Token"),(0,i.kt)("li",{parentName:"ul"},"Update commit statuses"),(0,i.kt)("li",{parentName:"ul"},"Checkout Main Repository and CI Repository")),(0,i.kt)("h3",{id:"how-to-use-actions"},"How to use Actions"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Add a job for step summary action"),(0,i.kt)("li",{parentName:"ul"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"start-action")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"end-action")," in GitHub Actions Job")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"jobs:\n  gha-trigger-summary:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: gha-trigger/step-summary-action@v0.1.1\n        with:\n          data: ${{inputs.data}}\n  test:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: gha-trigger/start-action@v0.1.6\n        id: start\n        with:\n          data: ${{inputs.data}}\n          app_id: ${{secrets.APP_ID}}\n          app_private_key: ${{secrets.APP_PRIVATE_KEY}}\n\n      # Add your steps freely\n\n      - uses: gha-trigger/end-action@v0.1.3\n        if: always()\n        with:\n          github_token: ${{steps.start.outputs.github_app_token}}\n          state: ${{job.status}}\n")),(0,i.kt)("h2",{id:"use-github-app-instead-of--githubtoken-"},"Use GitHub App instead of ",(0,i.kt)("inlineCode",{parentName:"h2"},"${{ github.token }}")),(0,i.kt)("p",null,"To access Main Repository, you have to use access token other than ",(0,i.kt)("inlineCode",{parentName:"p"},"${{ github.token }}"),"."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/gha-trigger/start-action"},"gha-trigger/start-action")," outputs a GitHub App Token."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'- uses: gha-trigger/start-action@v0.1.6\n  id: start\n  with:\n    data: ${{inputs.data}}\n    app_id: ${{secrets.APP_ID}}\n    app_private_key: ${{secrets.APP_PRIVATE_KEY}}\n\n- name: Add a Pull Request Label\n  run: gh pr edit -R "${{env.GHA_REPOSITORY}}" "$PR_NUMBER" --add-label "help wanted"\n  env:\n    GITHUB_TOKEN: ${{steps.start.outputs.github_app_token}} # Use GitHub App Token\n')),(0,i.kt)("h2",{id:"useful-environment-variables"},"Useful environment variables"),(0,i.kt)("p",null,"As we described, to get data from ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," you have to parse ",(0,i.kt)("inlineCode",{parentName:"p"},"data")," with ",(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/learn-github-actions/expressions#fromjson"},"fromJSON"),"."),(0,i.kt)("p",null,"And default environment variables ",(0,i.kt)("inlineCode",{parentName:"p"},"GITHUB_*")," are different from normal GitHub Actions Workflow."),(0,i.kt)("p",null,"For example, if you want to get the pull request head ref, you can't use the default environment variable ",(0,i.kt)("inlineCode",{parentName:"p"},"GITHUB_HEAD_REF"),"."),(0,i.kt)("p",null,"You can get the pull request head ref as the following, but it is a bit complicated."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'env:\n  HEAD_REF: "${{fromJSON(inputs.data).event.pull_request.head.ref}}"\n')),(0,i.kt)("p",null,"To improve the situation, ",(0,i.kt)("inlineCode",{parentName:"p"},"start-action")," (",(0,i.kt)("inlineCode",{parentName:"p"},"set-env-action"),") sets useful environment variables."),(0,i.kt)("p",null,"GitHub Actions doesn't allow to override default environment variables, so ",(0,i.kt)("inlineCode",{parentName:"p"},"set-env-action")," sets environment variables ",(0,i.kt)("inlineCode",{parentName:"p"},"GHA_*"),"."),(0,i.kt)("p",null,"For example, you can get the pull request head ref by the environment variable ",(0,i.kt)("inlineCode",{parentName:"p"},"GHA_HEAD_REF"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'    steps:\n      - uses: gha-trigger/start-action@v0.1.6\n        id: start\n        with:\n          data: ${{inputs.data}}\n          app_id: ${{secrets.APP_ID}}\n          app_private_key: ${{secrets.APP_PRIVATE_KEY}}\n      - run: echo "$GHA_HEAD_REF"\n')),(0,i.kt)("p",null,"Please see ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/gha-trigger/set-env-action#set-environment-variables"},"the list of environment variables"),"."),(0,i.kt)("h3",{id:"override-default-environment-variables-in-run"},"Override default environment variables in ",(0,i.kt)("inlineCode",{parentName:"h3"},"run")),(0,i.kt)("p",null,"GitHub Actions doesn't allow to override default environment variables, but you can override them in ",(0,i.kt)("inlineCode",{parentName:"p"},"run"),".\n",(0,i.kt)("inlineCode",{parentName:"p"},"start-action")," (",(0,i.kt)("inlineCode",{parentName:"p"},"set-env-action"),") provides a useful environment variable ",(0,i.kt)("inlineCode",{parentName:"p"},"GHA_ENV"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'- run: |\n    echo "$GITHUB_REPOSITORY" # CI Repository\n    . "$GHA_ENV" # Overwrite default environment variables GITHUB_*\n    echo "$GITHUB_REPOSITORY" # Main Repository\n')),(0,i.kt)("h2",{id:"update-commit-statuses-per-workflow"},"Update commit statuses per workflow"),(0,i.kt)("p",null,"start-action and end-action are run per job, so commit statuses are updated per job by default.\nTo update commit statuses, these actions call GitHub API so it may cause GitHub API rate limiting.\nIf you'd like to decrease API call, you can update commit statuses per not job but workflow.\nTo do so, please do the following things."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Set the environment variable ",(0,i.kt)("inlineCode",{parentName:"li"},"GHA_WORKFLOW_COMMIT_STATUS")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"true")," in workflow scope"),(0,i.kt)("li",{parentName:"ul"},"Set the parameter ",(0,i.kt)("inlineCode",{parentName:"li"},"start_workflow")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"true")," at only one ",(0,i.kt)("inlineCode",{parentName:"li"},"start-action")),(0,i.kt)("li",{parentName:"ul"},"Run a job to update a commit status at the end of workflow usings ",(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idneeds"},"needs"),". You have to pass ",(0,i.kt)("a",{parentName:"li",href:"https://docs.github.com/en/actions/learn-github-actions/contexts#needs-context"},"needs context")," as an action input")),(0,i.kt)("p",null,"e.g."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"env:\n  GHA_WORKFLOW_COMMIT_STATUS: \"true\"\njobs:\n  foo:\n    steps:\n      - uses: gha-trigger/start-action@v0.1.6\n        id: start\n        with:\n          # ...\n          # commit status is changed to \"pending\"\n          start_workflow: true # set this parameter at only this step\n      # ...\n      - uses: gha-trigger/end-action@v0.1.3\n        # commit status isn't changed\n        if: always()\n        with:\n          github_token: ${{steps.start.outputs.github_app_token}}\n  bar:\n    steps:\n      - uses: gha-trigger/start-action@v0.1.6\n        id: start\n        with:\n          # ...\n          # Don't set the parameter `start_workflow`\n          # commit status isn't changed\n      # ...\n      - uses: gha-trigger/end-action@v0.1.3\n        if: always()\n        # commit status isn't changed\n        with:\n          github_token: ${{steps.start.outputs.github_app_token}}\n\n  status-check:\n    needs: [foo, bar] # Run this job lastly\n    if: always()\n    steps:\n      - uses: gha-trigger/start-action@v0.1.6\n        id: start\n        with:\n          # ...\n          # Don't set the parameter `update_commit_status`\n          # commit status isn't changed\n      - uses: gha-trigger/end-action@v0.1.3\n        if: always()\n        with:\n          github_token: ${{steps.start.outputs.github_app_token}}\n          # commit status is updated using `needs.*.result`\n          needs: ${{toJson(needs)}}\n")),(0,i.kt)("h2",{id:"-optional-create-branches-for-oidc"},"\ud83d\udca1 (Optional) Create branches for OIDC"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect"},"About security hardening with OpenID Connect")),(0,i.kt)("p",null,"GitHub Actions supports OpenID Connect."),(0,i.kt)("p",null,"If you want to use OIDC and change the permission according to the event, it is useful to create branches in CI Repository for OIDC."),(0,i.kt)("p",null,"For example, you can create a branch ",(0,i.kt)("inlineCode",{parentName:"p"},"pull_request")," and run GitHub Actions Workflow for pull request with this branch,\nand allow those workflows to assume the AWS IAM Role that has read-only permission."))}c.isMDXComponent=!0}}]);